
---

### 📝 [155] 最小栈 —— 状态快照与栈语义的完美融合

#### 🔍 题目核心
> 设计一个栈，支持 `push`、`pop`、`top` 和 **`getMin`（O(1) 时间）**。  
> 要求：所有操作必须符合栈的 **LIFO（后进先出）** 语义。

**关键挑战**：  
- 如何在不破坏栈结构的前提下，**实时维护全局最小值**？  
- `pop` 操作会改变栈状态，最小值必须随之动态更新。

---

#### 💡 正确解法：状态快照法（每个栈帧自带最小值）

##### ✅ 核心思想
- **不使用辅助栈**，而是在主栈的每个元素中**打包存储两个信息**：
  - `.first`：当前压入的值 `val`；
  - `.second`：**从栈底到当前位置（含当前）的所有元素中的最小值**。
- 这样，**栈顶元素始终携带“当前全局最小值”的快照**。

##### ✅ 操作解析
```cpp
void push(int val) {
    int currentMin = min(getMin(), val); // 基于当前栈顶的最小值更新
    st.emplace(val, currentMin);
}

int top()       { return st.top().first;  } // 用户数据
int getMin()    { return st.top().second; } // 历史最小快照
void pop()      { st.pop();               } // 同时移除值与最小值，保持同步
```

##### ✅ 为何不违反栈规则？
- 所有操作（`push`/`pop`/`top`）**仅作用于栈顶**，完全符合 LIFO；
- `.second` 不是“额外数据”，而是**当前栈状态下最小值的自然属性**；
- `pop` 后，新栈顶的 `.second` 自动成为新的全局最小值——**无需回溯或重算**。

> ✅ **本质：将“历史最小值”作为栈状态的一部分进行封装，而非外部维护。**

---

#### ⚠️ 常见误区与反思

| 误区 | 正确认知 |
|------|--------|
| **“pair 是键值对，first 是 key，second 是 value”** | ❌ `pair` 在此仅为**二元组容器**，无键值语义；`.first` 是用户数据，`.second` 是衍生状态 |
| **“最小值应单独用一个变量存储”** | ❌ `pop` 会移除当前最小值，若无快照，无法恢复上一状态的最小值 |
| **“这样浪费空间”** | ✅ 空间换时间的经典权衡；O(n) 空间换取 O(1) 查询，符合题目要求 |
| **“没意识到这是合法栈操作”** | ✅ 关键突破：**栈元素可携带元信息**，只要操作仍限于栈顶，就不违反 LIFO |

---

#### 🧠 设计范式提炼：状态内嵌式数据结构

| 特征 | 应对策略 |
|------|--------|
| **需维护历史极值/统计量** | 将极值作为元素属性，随主数据一同入栈/出栈 |
| **操作必须 O(1)** | 避免遍历，利用栈顶自包含完整状态 |
| **接口需简洁无参** | `getMin()` 无需参数，因状态已内置于栈顶 |

> ✅ **本题是“辅助信息内嵌”设计模式的典范**：用结构化元素替代多个平行容器，提升一致性与可维护性。

---

#### 🔧 实现细节优化建议

当前代码使用**哨兵初始化**：
```cpp
MinStack() { st.emplace(0, INT_MAX); }
```
虽能避免空栈判断，但略显冗余。更简洁写法（推荐）：
```cpp
void push(int val) {
    if (st.empty()) 
        st.emplace(val, val);
    else 
        st.emplace(val, min(val, st.top().second));
}
// getMin() 和 top() 前加 assert(!st.empty()) 或依赖题目保证非空调用
```
> ✅ **去除哨兵后逻辑更清晰，且节省一次无效存储。**

---

#### 📌 总结
> **最小栈的本质不是“额外记录最小值”，而是“让每个栈帧自描述其历史最小状态”。**  
> 通过 `pair<int, int>` 将**用户数据**与**系统元数据**绑定，既严格遵守栈的 LIFO 规则，又实现 O(1) 极值查询。  
> 本题深刻揭示了设计类问题的核心哲学：**良好的封装不是隐藏复杂度，而是将约束转化为结构的一部分。**

---
